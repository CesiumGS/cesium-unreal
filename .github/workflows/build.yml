name: Cesium for Unreal
on: [push]
jobs:
  QuickChecks:
    name: "Quick Checks"
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Check source formatting
        run: |
          npm install
          npm run format -- --dry-run -Werror
  Windows51:
    uses: ./.github/workflows/buildWindows.yml
    secrets: inherit
    with:
      runner-label: windows-2019
      unreal-engine-version: "5.1.0"
      unreal-engine-zip: "s3://cesium-unreal-engine/5.1.1/Windows/UE_5.1.1.zip"
      unreal-program-name: "UE_5.1"
      upload-package-base-name: "CesiumForUnreal-51-windows"
      # These are specified in the Unreal Engine release notes under "IDE Version the Build farm compiles against"
      # and using them ensures we're compiling our plugin in the exact same way that Unreal Engine itself is compiled.
      cmake-generator: "Visual Studio 16 2019"
      cmake-toolchain: "version=14.29"
      cmake-platform: "x64,version=10.0.18362.0"
      visual-studio-version: "2019"
      visual-studio-components: "Microsoft.VisualStudio.Component.VC.14.29.16.10.x86.x64,Microsoft.VisualStudio.Component.Windows10SDK.18362"
  TestWindows51:
    needs: [Windows51]
    uses: ./.github/workflows/testWindows.yml
    secrets: inherit
    with:
      runner-label: windows-2019
      unreal-engine-zip: "s3://cesium-unreal-engine/5.1.1/Windows/UE_5.1.1.zip"
      unreal-program-name: "UE_5.1"
      test-package-base-name: "CesiumForUnreal-51-windows"
  Android51:
    uses: ./.github/workflows/buildAndroid.yml
    secrets: inherit
    with:
      runner-label: windows-2019
      unreal-engine-version: "5.1.0"
      unreal-engine-zip: "s3://cesium-unreal-engine/5.1.1/Windows/UE_5.1.1.zip"
      unreal-program-name: "UE_5.1"
      upload-package-base-name: "CesiumForUnreal-51-android"
      android-ndk-version: "r25b"
  Linux51:
    uses: ./.github/workflows/buildLinux.yml
    secrets: inherit
    with:
      runner-label: ubuntu-22.04
      unreal-engine-version: "5.1.0"
      unreal-engine-zip: "s3://cesium-unreal-engine/5.1.0/Linux/Linux_Unreal_Engine_5.1.0.zip"
      unreal-program-name: "UE_5.1"
      upload-package-base-name: "CesiumForUnreal-51-linux"
      clang-version: "v20_clang-13.0.1-centos7"
  Combine51:
    runs-on: ubuntu-latest
    needs: [Windows51, Linux51, Android51]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Set environment variables
        run: |
          export CESIUM_UNREAL_VERSION=$GITHUB_REF_NAME
          export BUILD_CESIUM_UNREAL_PACKAGE_NAME="CesiumForUnreal-51-${CESIUM_UNREAL_VERSION}"
          # Make these available to subsequent steps
          echo "CESIUM_UNREAL_VERSION=$CESIUM_UNREAL_VERSION" >> $GITHUB_ENV
          echo "BUILD_CESIUM_UNREAL_PACKAGE_NAME=$BUILD_CESIUM_UNREAL_PACKAGE_NAME" >> $GITHUB_ENV
      - name: Download Android build
        uses: actions/download-artifact@v4
        with:
          name: CesiumForUnreal-51-android-${{ env.CESIUM_UNREAL_VERSION}}
          path: combine
      - name: Download Linux build
        uses: actions/download-artifact@v4
        with:
          name: CesiumForUnreal-51-linux-${{ env.CESIUM_UNREAL_VERSION}}
          path: combine
      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: CesiumForUnreal-51-windows-${{ env.CESIUM_UNREAL_VERSION}}
          path: combine
      - name: Unreal Marketplace Workaround
        run: |
          # The UE Marketplace deletes our Intermediates directory and fails to produces new
          # intermediates for the Linux platform. The Marketplace team has suggested we copy
          # them to the LinuxIntermediate directory instead, as a workaround. Users still have
          # to move these files to the correct place manually, though, in order for Linux builds
          # to succeed.
          mkdir -p combine/CesiumForUnreal/LinuxIntermediate/Build/Linux
          cp -r combine/CesiumForUnreal/Intermediate/Build/Linux/* combine/CesiumForUnreal/LinuxIntermediate/Build/Linux
      - name: Publish combined package artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUILD_CESIUM_UNREAL_PACKAGE_NAME}}
          path: combine
  TestPackage51:
    needs: [Combine51]
    uses: ./.github/workflows/testPackageOnWindows.yml
    secrets: inherit
    with:
      runner-label: windows-2019
      unreal-engine-zip: "s3://cesium-unreal-engine/5.1.1/Windows/UE_5.1.1.zip"
      unreal-program-name: "UE_5.1"
      unreal-engine-association: "5.1"
      test-package-base-name: "CesiumForUnreal-51"
      visual-studio-version: "2019"
      visual-studio-components: "Microsoft.VisualStudio.Component.VC.14.29.16.10.x86.x64,Microsoft.VisualStudio.Component.Windows10SDK.18362"
