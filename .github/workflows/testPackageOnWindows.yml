name: Test Package On Windows

on:
  workflow_call:
    inputs:
      unreal-engine-association:
        required: true
        type: string
      unreal-runner-label:
        required: true
        type: string
      unreal-binaries-path:
        required: true
        type: string
      unreal-batch-files-path:
        required: true
        type: string
      unreal-plugins-path:
        required: true
        type: string
      test-package-base-name:
        required: true
        type: string
jobs:
  test:
    runs-on: ["self-hosted","windows","x64","${{ inputs.unreal-runner-label }}"]
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # so that `git describe` works.
          sparse-checkout: |
            .github
            TestsProject      
      - name: Set environment variables
        run: |
          $env:CESIUM_UNREAL_VERSION=$(git describe)
          $env:PLUGIN_PACKAGE_NAME="${{ inputs.test-package-base-name }}-${env:CESIUM_UNREAL_VERSION}"
          $env:UNREAL_BINARIES_PATH="${{ inputs.unreal-binaries-path }}"
          $env:UNREAL_BATCH_FILES_PATH="${{ inputs.unreal-batch-files-path }}"
          $env:UNREAL_PLUGINS_PATH="${{ inputs.unreal-plugins-path }}"
          $env:TESTS_PROJECT_ROOT="$env:GITHUB_WORKSPACE/TestsProject"
          $env:USER_DATA_CACHE="C:/Users/ec2-user/AppData/Local/UnrealEngine/Common/DerivedDataCache"

          # Make these available to subsequent steps
          echo "PLUGIN_PACKAGE_NAME=${env:PLUGIN_PACKAGE_NAME}" >> $env:GITHUB_ENV
          echo "UNREAL_BINARIES_PATH=${env:UNREAL_BINARIES_PATH}" >> $env:GITHUB_ENV
          echo "UNREAL_BATCH_FILES_PATH=${env:UNREAL_BATCH_FILES_PATH}" >> $env:GITHUB_ENV
          echo "UNREAL_PLUGINS_PATH=${env:UNREAL_PLUGINS_PATH}" >> $env:GITHUB_ENV
          echo "TESTS_PROJECT_ROOT=${env:TESTS_PROJECT_ROOT}" >> $env:GITHUB_ENV
          echo "USER_DATA_CACHE=${env:USER_DATA_CACHE}" >> $env:GITHUB_ENV

          # Confirm vars to the console
          echo ""
          echo PLUGIN_PACKAGE_NAME=$env:PLUGIN_PACKAGE_NAME          
          echo UNREAL_BINARIES_PATH=$env:UNREAL_BINARIES_PATH
          echo UNREAL_BATCH_FILES_PATH=$env:UNREAL_BATCH_FILES_PATH
          echo UNREAL_PLUGINS_PATH=$env:UNREAL_PLUGINS_PATH
          echo TESTS_PROJECT_ROOT=$env:TESTS_PROJECT_ROOT
          echo USER_DATA_CACHE=$env:USER_DATA_CACHE
      - name: Download plugin artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.PLUGIN_PACKAGE_NAME}}
          path: download          
      - name: Install plugin to Unreal Engine
        run: |
          dir download/CesiumForUnreal
          md "$env:UNREAL_PLUGINS_PATH/Marketplace"
          cp "download/CesiumForUnreal" "$env:UNREAL_PLUGINS_PATH/Marketplace" -r      
      - name: Prime user cook cache for speed # for faster shader compiles
        run: |
          dir "$env:TESTS_PROJECT_ROOT/UserDerivedDataCache/${{ inputs.unreal-runner-label }}" 
          cp "$env:TESTS_PROJECT_ROOT/UserDerivedDataCache/${{ inputs.unreal-runner-label }}" "$env:USER_DATA_CACHE" -r
      - name: Overwrite tests project engine association
        run: |
          ((Get-Content -path "$env:TESTS_PROJECT_ROOT/TestsProject.uproject" -Raw) -replace '"EngineAssociation": "5.0"','"EngineAssociation": "${{ inputs.unreal-engine-association }}"') | Set-Content -Path "$env:TESTS_PROJECT_ROOT/TestsProject.uproject"
      - name: Verify tests engine association
        run: |
          dir download/CesiumForUnreal
          Get-Content "$env:TESTS_PROJECT_ROOT/TestsProject.uproject" | select-string -pattern "EngineAssociation"
      - name: Verify plugin engine version
        run: |
          dir download/CesiumForUnreal
          Get-Content "CesiumForUnreal.uplugin" | select-string -pattern "EngineVersion"
      - name: Run packaging test
        run: |
          cd "$env:UNREAL_BATCH_FILES_PATH"
          ./RunUAT.bat -ScriptsForProject="$env:TESTS_PROJECT_ROOT/TestsProject.uproject" Turnkey -command=VerifySdk -platform=Win64 -UpdateIfNeeded -EditorIO -EditorIOPort=54342  -project="$env:TESTS_PROJECT_ROOT/TestsProject.uproject" BuildCookRun -nop4 -utf8output -nocompileeditor -skipbuildeditor -cook  -project="$env:TESTS_PROJECT_ROOT/TestsProject.uproject"  -unrealexe="$env:UNREAL_BINARIES_PATH/UnrealEditor-Cmd.exe" -platform=Win64 -ddc=InstalledDerivedDataBackendGraph -installed -stage -archive -package -build -compressed -iostore -pak -prereqs -archivedirectory="$env:GITHUB_WORKSPACE/TestPackaging" -nocompile
      - name: Sanity check
        run: |
          if (Test-Path "$env:GITHUB_WORKSPACE/TestPackaging/Windows/TestsProject.exe")  { exit 0 } Else { exit 1 }
